<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KakaReza BlackJack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <style>
    /* ... [ALL YOUR CSS UNCHANGED, as posted above] ... */
    /* For brevity, use your posted CSS exactly as-is */
  </style>
</head>
<body>
  <div id="kaka-pattern"></div>
  <div id="fixed-container">
    <div class="branding-spacer"></div>
    <h1>KakaReza BlackJack</h1>
    <div id="game-area">
      <div class="section-title">Dealer</div>
      <div class="cards-area" id="dealer-cards-container"></div>
      <div class="cards-area" id="player-cards-container"></div>
      <div id="bankroll-bet-row">
        <div class="bankroll-box">Bank Roll
          <span class="bankroll-value" id="chips-total">5000</span>
        </div>
        <div class="bet-box">Current Bet
          <span class="bet-value" id="current-bet-value">0</span>
        </div>
      </div>
    </div>
    <div id="actions-bar"></div>
    <div id="bottom-controls">
      <div id="chips">
        <div class="chip chip20" data-value="20">20</div>
        <div class="chip chip50" data-value="50">50</div>
        <div class="chip chip100" data-value="100">100</div>
        <div class="chip chip500" data-value="500">500</div>
        <div class="chip chip1000" data-value="1000">1000</div>
      </div>
      <div id="bet-info">Place your bet (Min: 20)</div>
      <div id="bet-controls">
        <button id="clear-bet">Clear Bet</button>
        <button id="redo-bet">Redo Bet</button>
        <button id="deal-btn">Deal</button>
      </div>
      <button id="next-hand-btn" style="display:none;">Next Hand</button>
    </div>
  </div>
  <div id="reload-box">
    <button id="reload-btn" title="Get 10,000 chips" aria-label="Reload chips">ðŸ’²ðŸ’²</button>
    <div id="reload-label">Reload</div>
  </div>
  <div id="result-anim" style="display:none;"></div>
  <div id="status-message" style="text-align:center; min-height:24px; margin:10px 0 0 0; color:#42a5f5; text-shadow:1px 1px 4px #000; font-weight:bold;"></div>
  <script>
    // --- [All constants and variables as before] ---
    const SUITS = ['hearts', 'diamonds', 'spades', 'clubs'];
    const VALUES = [
      {name: 'A', value: 11},
      {name: '2', value: 2},
      {name: '3', value: 3},
      {name: '4', value: 4},
      {name: '5', value: 5},
      {name: '6', value: 6},
      {name: '7', value: 7},
      {name: '8', value: 8},
      {name: '9', value: 9},
      {name: '10', value: 10},
      {name: 'J', value: 10},
      {name: 'Q', value: 10},
      {name: 'K', value: 10}
    ];
    let playerChips = 5000, bet = 0, lastBet = 0, deck = [], playerHands = [], currentHandIdx = 0, dealerHand = [];
    let inPlay = false, canSplit = false, canDouble = false, splitActive = false, playerBlackjack = false, dealerBlackjack = false, handResults = [], animTimeouts = [], waitingNextHand = false;
    const chipsTotal = document.getElementById('chips-total');
    const chipsArea = document.getElementById('chips');
    const betInfo = document.getElementById('bet-info');
    const clearBetBtn = document.getElementById('clear-bet');
    const redoBetBtn = document.getElementById('redo-bet');
    const dealBtn = document.getElementById('deal-btn');
    const dealerCardsContainer = document.getElementById('dealer-cards-container');
    const playerCardsContainer = document.getElementById('player-cards-container');
    const actionsBar = document.getElementById('actions-bar');
    const statusMsg = document.getElementById('status-message');
    const nextHandBtn = document.getElementById('next-hand-btn');
    const bankrollBox = document.getElementById('chips-total');
    const betBox = document.getElementById('current-bet-value');
    const resultAnim = document.getElementById('result-anim');
    const reloadBtn = document.getElementById('reload-btn');

    // --- [Functions as before, but with improved Next Hand logic and button pulse management] ---

    function buildDeck() {
      let d = [];
      for (let n = 0; n < 8; n++) for (const s of SUITS) for (const v of VALUES) d.push({suit: s, name: v.name, value: v.value});
      for (let i = d.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [d[i], d[j]] = [d[j], d[i]]; }
      return d;
    }
    function handValue(hand) {
      let total = 0, aces = 0;
      for (const card of hand) { total += card.value; if (card.name === 'A') aces++; }
      while (total > 21 && aces > 0) { total -= 10; aces--; }
      return total;
    }
    function isBlackjack(hand) { return hand.length === 2 && handValue(hand) === 21; }
    function isPair(hand) { return hand.length === 2 && hand[0].name === hand[1].name; }
    function canSplitHand(hand) { return isPair(hand) && playerChips >= bet && playerHands.length < 2; }
    function canDoubleDown(hand) { return hand.length === 2 && playerChips >= bet; }
    function resetGame() {
      clearTimeouts(); bet = 0; playerHands = []; currentHandIdx = 0; dealerHand = [];
      inPlay = false; canSplit = false; canDouble = false; splitActive = false;
      playerBlackjack = false; dealerBlackjack = false; handResults = [];
      waitingNextHand = false;
      updateChips(); updateBetInfo(); renderHands(); renderActions();
      statusMsg.textContent = '';
      nextHandBtn.style.display = 'none';
      nextHandBtn.classList.remove('pulse');
      resultAnim.style.display = 'none';
      enableBetting(true);
      updateFlashing();
      betInfo.classList.add('pulse');
      updateBetBox();
      updateReloadBtn();
    }
    function clearTimeouts() { for (const t of animTimeouts) clearTimeout(t); animTimeouts = []; }
    function updateChips() { chipsTotal.textContent = playerChips; }
    function updateBetBox() { betBox.textContent = bet; }
    function updateBetInfo() {
      betInfo.textContent = bet > 0 ? `Current Bet: ${bet}` : 'Place your bet (Min: 20)';
      updateBetBox();
      updateFlashing();
    }
    function renderHands(showDealerHole = false, anim = false, hitIdx = null) {
      dealerCardsContainer.innerHTML = '';
      let dealerHandDiv = document.createElement('div'); dealerHandDiv.className = 'hand';
      dealerHand.forEach((card, idx) => {
        let cardDiv = document.createElement('div'); cardDiv.className = 'card suit-' + card.suit;
        if (idx === 1 && !showDealerHole && inPlay) cardDiv.classList.add('back');
        else {
          let suitSym = {'hearts':'â™¥','diamonds':'â™¦','spades':'â™ ','clubs':'â™£'}[card.suit];
          cardDiv.innerHTML = `<span class="card-rank">${card.name}${suitSym}</span>`;
        }
        if (anim && idx === dealerHand.length - 1 && hitIdx === 'dealer') cardDiv.classList.add('hit-anim');
        else if (anim && dealerHand.length <= 2) cardDiv.classList.add('deal-anim');
        dealerHandDiv.appendChild(cardDiv);
      });
      let dealerValDiv = document.createElement('div'); dealerValDiv.className = 'hand-value-side';
      dealerValDiv.textContent = (showDealerHole || !inPlay) ? handValue(dealerHand) : '';
      dealerHandDiv.appendChild(dealerValDiv); dealerCardsContainer.appendChild(dealerHandDiv);

      playerCardsContainer.innerHTML = '';
      let playerHandDiv = document.createElement('div'); playerHandDiv.className = 'hand';
      playerHands[0]?.forEach((card, idx) => {
        let cardDiv = document.createElement('div'); cardDiv.className = 'card suit-' + card.suit;
        let suitSym = {'hearts':'â™¥','diamonds':'â™¦','spades':'â™ ','clubs':'â™£'}[card.suit];
        cardDiv.innerHTML = `<span class="card-rank">${card.name}${suitSym}</span>`;
        if (anim && idx === playerHands[0].length - 1 && hitIdx === 'player') cardDiv.classList.add('hit-anim');
        else if (anim && playerHands[0].length <= 2) cardDiv.classList.add('deal-anim');
        playerHandDiv.appendChild(cardDiv);
      });
      let playerValDiv = document.createElement('div'); playerValDiv.className = 'hand-value-side';
      playerValDiv.textContent = playerHands[0] ? handValue(playerHands[0]) : '';
      playerHandDiv.appendChild(playerValDiv); playerCardsContainer.appendChild(playerHandDiv);
    }
    function renderActions() {
      actionsBar.innerHTML = '';
      if (!inPlay) return;
      let hand = playerHands[currentHandIdx];
      let hitBtn = document.createElement('button'); hitBtn.textContent = 'Hit'; hitBtn.className = 'hit-btn'; hitBtn.onclick = () => playerHit();
      let standBtn = document.createElement('button'); standBtn.textContent = 'Stay'; standBtn.className = 'stand-btn'; standBtn.onclick = () => playerStand();
      let dblBtn = null, splitBtn = null;
      if (canDoubleDown(hand)) { dblBtn = document.createElement('button'); dblBtn.textContent = 'Double'; dblBtn.className = 'double-btn'; dblBtn.onclick = () => playerDouble(); }
      if (canSplitHand(hand)) { splitBtn = document.createElement('button'); splitBtn.textContent = 'Split'; splitBtn.className = 'split-btn'; splitBtn.onclick = () => playerSplit(); }
      actionsBar.appendChild(hitBtn);
      actionsBar.appendChild(standBtn);
      if (dblBtn) actionsBar.appendChild(dblBtn);
      if (splitBtn) actionsBar.appendChild(splitBtn);
      updateFlashing();
    }
    function dealCard(toHand, anim = true) { if (deck.length < 20) deck = buildDeck(); let card = deck.pop(); toHand.push(card); }
    function enableBetting(val) {
      let chips = document.querySelectorAll('.chip');
      let chipsParent = document.getElementById('chips');
      chips.forEach(c => c.style.pointerEvents = val ? 'auto' : 'none');
      chipsParent.style.pointerEvents = val ? 'auto' : 'none';
      clearBetBtn.disabled = !val; redoBetBtn.disabled = !val;
      dealBtn.disabled = !val || bet < 20;
      updateFlashing();
    }
    function updateFlashing() {
      let chips = document.querySelectorAll('.chip');
      let actionButtons = actionsBar.querySelectorAll('button');
      let hitBtn = actionsBar.querySelector('.hit-btn');
      let standBtn = actionsBar.querySelector('.stand-btn');
      let doubleBtn = actionsBar.querySelector('.double-btn');
      let splitBtn = actionsBar.querySelector('.split-btn');
      chips.forEach(c => c.classList.remove('pulse'));
      dealBtn.classList.remove('pulse');
      reloadBtn.classList.remove('pulse');
      actionButtons.forEach(b => b.classList.remove('pulse'));
      nextHandBtn.classList.remove('pulse');
      if (playerChips < 20) {
        reloadBtn.classList.add('pulse');
        return;
      }
      if (!inPlay && !waitingNextHand && bet === 0) {
        chips.forEach(c => c.classList.add('pulse'));
        return;
      }
      if (!inPlay && !waitingNextHand && bet > 0) {
        dealBtn.classList.add('pulse');
        return;
      }
      if (waitingNextHand) {
        nextHandBtn.style.display = '';
        nextHandBtn.classList.add('pulse');
        // Only Next Hand should pulse now!
        return;
      }
      if (inPlay && !waitingNextHand) {
        if (hitBtn) hitBtn.classList.add('pulse');
        if (standBtn) standBtn.classList.add('pulse');
        if (doubleBtn && !doubleBtn.disabled) doubleBtn.classList.add('pulse');
        if (splitBtn && !splitBtn.disabled) splitBtn.classList.add('pulse');
      }
    }
    chipsArea.onclick = (e) => {
      if (!e.target.classList.contains('chip')) return;
      if (inPlay || waitingNextHand) return;
      if (playerChips < 20) return;
      let val = parseInt(e.target.getAttribute('data-value'));
      if (bet + val > playerChips) return;
      bet += val;
      updateBetInfo();
      if (bet >= 20) { dealBtn.disabled = false; }
    };
    clearBetBtn.onclick = () => { if (inPlay || waitingNextHand) return; bet = 0; updateBetInfo(); dealBtn.disabled = true; };
    redoBetBtn.onclick = () => { if (inPlay || waitingNextHand) return; if (lastBet > 0 && lastBet <= playerChips) { bet = lastBet; updateBetInfo(); if (bet >= 20) { dealBtn.disabled = false; } } };
    dealBtn.onclick = () => { if (inPlay || bet < 20 || bet > playerChips || waitingNextHand) return; dealBtn.classList.remove('pulse'); betInfo.classList.remove('pulse'); dealBtn.disabled = true; startHand(); };
    function startHand() {
      clearTimeouts(); inPlay = true; playerBlackjack = false; dealerBlackjack = false; playerHands = [[]]; currentHandIdx = 0; dealerHand = [];
      playerChips -= bet; lastBet = bet; updateChips(); updateBetInfo(); enableBetting(false); renderHands(false, true);
      setTimeout(() => { dealCard(playerHands[0]); renderHands(false, true);
        animTimeouts.push(setTimeout(() => { dealCard(dealerHand); renderHands(false, true);
          animTimeouts.push(setTimeout(() => { dealCard(playerHands[0]); renderHands(false, true);
            animTimeouts.push(setTimeout(() => { dealCard(dealerHand); renderHands(false, true); afterInitialDeal(); }, 350));
          }, 350));
        }, 350));
      }, 350);
    }
    function afterInitialDeal() {
      canSplit = canSplitHand(playerHands[0]);
      canDouble = canDoubleDown(playerHands[0]);
      playerBlackjack = isBlackjack(playerHands[0]);
      dealerBlackjack = isBlackjack(dealerHand);
      renderHands(false); renderActions();
      if (playerBlackjack || dealerBlackjack) setTimeout(() => finishHand(), 700);
      else statusMsg.textContent = 'Your move!';
    }
    function playerHit() {
      let hand = playerHands[currentHandIdx]; dealCard(hand);
      renderHands(false, false, 'player');
      let cards = playerCardsContainer.querySelectorAll('.card');
      if (cards.length) { cards[cards.length - 2]?.classList.remove('hit-anim', 'deal-anim'); cards[cards.length - 1]?.classList.add('hit-anim'); }
      setTimeout(() => { renderHands(false); if (handValue(hand) > 21) { statusMsg.textContent = 'Busted!'; setTimeout(() => nextHandOrFinish(), 700); } else renderActions(); }, 350);
    }
    function playerStand() { nextHandOrFinish(); }
    function playerDouble() {
      if (playerChips < bet) return;
      playerChips -= bet; updateChips();
      let hand = playerHands[currentHandIdx]; dealCard(hand); renderHands(false, false, 'player');
      let cards = playerCardsContainer.querySelectorAll('.card');
      if (cards.length) { cards[cards.length - 2]?.classList.remove('hit-anim', 'deal-anim'); cards[cards.length - 1]?.classList.add('hit-anim'); }
      setTimeout(() => { renderHands(false); nextHandOrFinish(); }, 350);
    }
    function playerSplit() {
      if (!canSplitHand(playerHands[currentHandIdx])) return;
      if (playerChips < bet) return;
      playerChips -= bet; updateChips();
      let hand = playerHands[currentHandIdx]; let newHand = [hand.pop()];
      playerHands.push(newHand); dealCard(hand); dealCard(newHand); renderHands(false, true);
      setTimeout(() => { renderHands(false); renderActions(); }, 350);
    }
    function nextHandOrFinish() {
      if (currentHandIdx < playerHands.length - 1) { currentHandIdx++; renderHands(false); renderActions(); statusMsg.textContent = 'Next hand!'; }
      else finishHand();
    }
    function finishHand() {
      inPlay = false; renderActions(); renderHands(true); setTimeout(() => dealerPlay(), 650);
    }
    function dealerPlay() {
      let dealerAnim = () => {
        if (handValue(dealerHand) < 17 || (handValue(dealerHand) === 17 && hasSoft17(dealerHand))) {
          dealCard(dealerHand); renderHands(true, false, 'dealer');
          let cards = dealerCardsContainer.querySelectorAll('.card');
          if (cards.length) { cards[cards.length - 2]?.classList.remove('hit-anim', 'deal-anim'); cards[cards.length - 1]?.classList.add('hit-anim'); }
          setTimeout(dealerAnim, 350);
        } else { renderHands(true); setTimeout(() => settleBets(), 700); }
      };
      dealerAnim();
    }
    function hasSoft17(hand) {
      let total = 0, aces = 0;
      for (const card of hand) { total += card.value; if (card.name === 'A') aces++; }
      return total === 17 && aces > 0;
    }
    function showResultAnimation(type) {
      resultAnim.className = type === 'win' ? 'win-anim' : 'lose-anim';
      resultAnim.textContent = type === 'win' ? 'You Win!' : 'You Lose!';
      resultAnim.style.display = '';
      setTimeout(() => { resultAnim.style.display = 'none'; }, 2000);
    }
    function settleBets() {
      let dealerVal = handValue(dealerHand);
      let messages = [], totalWin = 0, winAnim = false, loseAnim = false;
      for (let i = 0; i < playerHands.length; i++) {
        let hand = playerHands[i], val = handValue(hand), win = 0, msg = '';
        if (isBlackjack(hand)) {
          if (isBlackjack(dealerHand)) { win = bet; msg = 'Push (Both Blackjack)'; }
          else { win = Math.floor(bet * 2.5); msg = 'Blackjack! You win 3:2!'; winAnim = true; }
        } else if (val > 21) { win = 0; msg = 'Busted!'; loseAnim = true; }
        else if (dealerVal > 21) { win = bet * 2; msg = 'Dealer busts! You win!'; winAnim = true; }
        else if (val > dealerVal) { win = bet * 2; msg = 'You win!'; winAnim = true; }
        else if (val === dealerVal) { win = bet; msg = 'Push!'; }
        else { win = 0; msg = 'You lose!'; loseAnim = true; }
        playerChips += win;
        totalWin += win;
        messages.push(`Hand ${playerHands.length > 1 ? (i+1) + ': ' : ''}${msg}`);
      }
      updateChips(); updateBetBox(); statusMsg.textContent = messages.join(' | ');
      // Always show animation for win or lose
      if (winAnim) showResultAnimation('win');
      else if (loseAnim) showResultAnimation('lose');
      else showResultAnimation('lose'); // For push, show lose animation (or you can make a push animation)
      updateReloadBtn();
      // Always show Next Hand button, pulse it, and only allow Next Hand at this stage
      setTimeout(() => {
        waitingNextHand = true;
        nextHandBtn.style.display = '';
        nextHandBtn.classList.add('pulse');
        enableBetting(false);
        updateFlashing();
      }, 200);
    }
    nextHandBtn.onclick = () => {
      waitingNextHand = false;
      nextHandBtn.classList.remove('pulse');
      nextHandBtn.style.display = 'none';
      resetGame();
    };
    reloadBtn.onclick = () => {
      if (playerChips < 20) {
        playerChips += 10000;
        updateChips();
        resetGame();
      }
    };
    function updateReloadBtn() {
      if (playerChips < 20) {
        reloadBtn.classList.remove('disabled');
        reloadBtn.classList.add('pulse');
        reloadBtn.title = "Get 10,000 chips";
        reloadBtn.setAttribute("aria-label", "Reload chips");
        reloadBtn.style.opacity = 1;
      } else {
        reloadBtn.classList.add('disabled');
        reloadBtn.classList.remove('pulse');
        reloadBtn.title = "Available only when out of chips";
        reloadBtn.setAttribute("aria-label", "Reload disabled");
        reloadBtn.style.opacity = 0.5;
      }
    }
    deck = buildDeck();
    resetGame();
    document.body.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });
    document.addEventListener('touchstart', function preventZoom(e) { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
  </script>
</body>
</html>
